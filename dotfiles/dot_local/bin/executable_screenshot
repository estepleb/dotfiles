#!/usr/bin/env bash

save_dir="$HOME/Pictures/Screenshots"
file="screenshot_$(date +%Y-%m-%d_%H-%M-%S).png"
full_path="$save_dir/$file"
mkdir -p "$save_dir"

action=$1
mode=${2:-area}

# Check for required commands
if ! command -v convert &> /dev/null; then
    echo "Error: ImageMagick not found."
    exit 1
fi

if ! command -v grimblast &> /dev/null; then
    echo "Error: grimblast not found."
    exit 1
fi

if ! command -v hyprctl &> /dev/null; then
    echo "Error: hyprctl not found."
    exit 1
fi

# Validate mode
case "$mode" in
	area)
	hyprctl dispatch submap screenshot
		;;
    active|output|area)
        # Valid modes, continue
        ;;
    *)
        echo "Invalid mode: $mode"
        echo "Usage: $0 {copy|save|copysave|edit} {active|output|area}"
        exit 1
        ;;
esac

# Validate action
case "$action" in
    copy|save|copysave|edit)
        # Valid actions, continue
        ;;
    *)
        echo "Invalid action: $action"
        echo "Usage: $0 {copy|save|copysave|edit} {active|output|area}"
        exit 1
        ;;
esac

# Execute grimblast command
if grimblast "$action" "$mode" "$full_path"; then
    case "$action" in
        copy)
            # Simple notification for copy
            notify-send -a "Grimblast" "Screenshot copied" "Screenshot copied to clipboard"
            ;;
        
        edit)
            # Get the most recent screenshot for editing
            recentFile=$(find "$save_dir" -name 'screenshot_*.png' -printf '%T+ %p\n' | sort -r | head -n 1 | cut -d' ' -f2-)
            
            if [ -n "$recentFile" ]; then
                satty -f "$recentFile" &
                notify-send -a "Grimblast" "Screenshot editor opened" "Editing in Satty"
            else
                echo "Error: No screenshot file found"
                exit 1
            fi
            ;;
        
        save|copysave)
            # Get the most recent screenshot
            recentFile=$(find "$save_dir" -name 'screenshot_*.png' -printf '%T+ %p\n' | sort -r | head -n 1 | cut -d' ' -f2-)
            
            if [ -z "$recentFile" ]; then
                echo "Error: No screenshot file found"
                exit 1
            fi
            
            # Create thumbnail
            thumb_dir="/tmp/screenshots_thumbs"
            mkdir -p "$thumb_dir"
            thumb_file="$thumb_dir/$(basename "$recentFile")"
            
            # Create a small thumbnail (max 256x256)
            convert "$recentFile" -resize 256x256 "$thumb_file" 2>/dev/null || thumb_file="$recentFile"
            
            # Notification message based on action
            if [ "$action" = "copysave" ]; then
                msg="Screenshot saved and copied"
            else
                msg="Screenshot saved"
            fi
            
            # Send notification with thumbnail and actions
            ACTION=$(notify-send -a "Screenshot" -i "$thumb_file" \
                "$msg" "$recentFile" \
                -A "view=View" -A "edit=Edit" -A "open=Open Folder")
            
            case "$ACTION" in
                view) xdg-open "$recentFile" ;;
                edit) satty -f "$recentFile" ;;
                open) xdg-open "$save_dir" ;;
            esac
            ;;
    esac
else
    echo "Error: Screenshot command failed"
    exit 1
fi
