#!/bin/bash
#
# Supports three modes:
# - Toggle mode: ./ostt-foot-float toggle (default)
# - Start mode: ./ostt-foot-float start  
# - Stop mode: ./ostt-foot-float stop
#
# Toggle: First run starts, second run stops
# Start/Stop: Explicit start and stop commands for more flexibility

# --- Configuration -----------------------------------------------------------
MODE="${1:-toggle}"
OSTT_BIN="${OSTT_BIN:-ostt}"

# If OSTT_BIN is just a command name (not a path), use 'which' to find it
if [[ "$OSTT_BIN" != */* ]]; then
    OSTT_BIN="$(which "$OSTT_BIN" 2>/dev/null || echo "$OSTT_BIN")"
fi

# Convert to absolute path if it exists
if [ -e "$OSTT_BIN" ]; then
    OSTT_BIN="$(cd "$(dirname "$OSTT_BIN")" && pwd)/$(basename "$OSTT_BIN")"
fi

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
FOOT_CONFIG="${HOME}/.config/ostt/foot-float.ini"
STATE_FILE="/tmp/ostt_active.pid"
LOCK_FILE="/tmp/ostt_launch.lock"

# --- Helpers -----------------------------------------------------------------
register_pid() {
    # Find the newly spawned ostt process (match binary path first)
    local NEW_PID
    NEW_PID=$(pgrep -f "^$OSTT_BIN" | tail -1)
    
    if [ -z "$NEW_PID" ]; then
        NEW_PID=$(ps aux | grep -v grep | grep "$(basename "$OSTT_BIN")" | awk '{print $2}' | tail -1)
    fi
    
    [ -n "$NEW_PID" ] && echo "$NEW_PID" > "$STATE_FILE"
}

# --- Sanity check -----------------------------------------------------------
if [ ! -x "$OSTT_BIN" ]; then
    notify-send "ostt: Binary not found at $OSTT_BIN"
    exit 1
fi

# --- Main logic -------------------------------------------------------------

# Handle explicit stop command
if [ "$MODE" = "stop" ]; then
    if [ -f "$STATE_FILE" ]; then
        PID=$(cat "$STATE_FILE" 2>/dev/null)
        if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
            kill "$PID" 2>/dev/null || true
        fi
        rm -f "$STATE_FILE"
    fi
    # Also kill any foot windows that might be stuck
    pkill -f "foot.*--app-id=ostt" 2>/dev/null || true
    exit 0
fi

# Handle explicit start command
if [ "$MODE" = "start" ]; then
    # Check if already running
    if [ -f "$STATE_FILE" ]; then
        PID=$(cat "$STATE_FILE" 2>/dev/null)
        if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
            # Already running, do nothing
            exit 0
        else
            # Clean up stale state
            rm -f "$STATE_FILE"
        fi
    fi
    
    # Check if foot window is already launching
    if pgrep -f "foot.*--app-id=ostt" > /dev/null; then
        exit 0
    fi
    
    # Start ostt
    foot --config "$FOOT_CONFIG" --app-id=ostt --title ostt "$OSTT_BIN" &
    sleep 0.5
    register_pid
    exit 0
fi

# Handle toggle mode (default)
if [ "$MODE" = "toggle" ]; then
    # Check if ostt is already running
    PID=""
    if [ -f "$STATE_FILE" ]; then
        PID=$(cat "$STATE_FILE" 2>/dev/null)
        
        if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
            # ostt is running → stop it
            kill "$PID" 2>/dev/null || true
            rm -f "$STATE_FILE"
            exit 0
        else
            # stale state file; clean up and fall through to start fresh
            rm -f "$STATE_FILE"
        fi
    fi
    
    # Check if foot window is already launching (prevents duplicates)
    if pgrep -f "foot.*--app-id=ostt" > /dev/null; then
        exit 0
    fi
    
    # ostt not running → spawn new window with Foot config in background
    foot --config "$FOOT_CONFIG" --app-id=ostt --title ostt "$OSTT_BIN" &
    sleep 0.5
    register_pid
    exit 0
fi

# Unknown mode
echo "Usage: $0 [toggle|start|stop]"
exit 1
