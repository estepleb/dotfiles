
#!/usr/bin/env bash

dotfiles_dir=$HOME/dotfiles
current_dir=$(pwd)
name=$1

parent_dir(){
    filepath=$1
    parentdir="$(basename "$(dirname "$filepath")")"
    echo "$parentdir"
}

get_package_dir(){
    # Given a path like ~/dotfiles/micro/.config/micro/backups/file.txt
    # Return ~/dotfiles/micro (the top-level package directory)
    local filepath=$1
    local dotfiles_root="${HOME}/dotfiles"
    
    # Get the relative path from dotfiles root
    local relpath="${filepath#$dotfiles_root/}"
    
    # Extract the first directory component (package name)
    local package_name="${relpath%%/*}"
    
    echo "${dotfiles_root}/${package_name}"
}

ignore(){
    local arg=$1
    local dotfiles_root="${HOME}/dotfiles"
    
    # Convert to absolute path if needed
    if [[ ! "$arg" =~ ^/ ]]; then
        arg="$(realpath "$arg")"
    fi
    
    # Check if path exists
    if [[ ! -e "$arg" ]]; then
        echo "Error: $arg does not exist"
        exit 1
    fi
    
    # Get the package directory
    local package_dir=$(get_package_dir "$arg")
    
    if [[ ! -d "$package_dir" ]]; then
        echo "Error: Could not determine package directory for $arg"
        exit 1
    fi
    
    local ignore_file="${package_dir}/.stow-local-ignore"
    
    # Determine what to ignore
    if [[ -f "$arg" ]]; then
        # It's a file - ask user
        local parent=$(parent_dir "$arg")
        echo "File detected: $arg"
        echo "Parent directory: $parent"
        read -p "Ignore the (d)irectory or the (f)ile? [d/f]: " choice
        
        case "$choice" in
            d|D)
                # Ignore the parent directory relative to package root
                local ignore_pattern="${arg%/*}"
                ignore_pattern="${ignore_pattern#$package_dir/}"
                ;;
            f|F)
                # Ignore the specific file relative to package root
                local ignore_pattern="${arg#$package_dir/}"
                ;;
            *)
                echo "Invalid choice. Cancelled."
                exit 1
                ;;
        esac
    elif [[ -d "$arg" ]]; then
        # It's a directory - ignore it directly
        local ignore_pattern="${arg#$package_dir/}"
    fi
    
    # Add to .stow-local-ignore if not already present
    if [[ -f "$ignore_file" ]] && grep -Fxq "$ignore_pattern" "$ignore_file"; then
        echo "Pattern '$ignore_pattern' already in $ignore_file"
    else
        echo "$ignore_pattern" >> "$ignore_file"
        echo "Added '$ignore_pattern' to $ignore_file"
    fi
}




if [[ -d $name ]]; then
    # Strip $HOME from current directory path
    relative_dir=${current_dir#$HOME/}
    
    mkdir -p "$dotfiles_dir/$name/$relative_dir"
    cp -r "$name" "$dotfiles_dir/$name/$relative_dir"
    echo "Backed up $name to $dotfiles_dir/$name/$relative_dir"
else
    echo "Error: $name is not a directory"
    exit 1
fi
